name: PR Build & Tests

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

jobs:
  backend-build:
    name: Backend Build & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        working-directory: backend
        run: mvn clean compile -B

      - name: Run tests
        working-directory: backend
        run: mvn test -B
        continue-on-error: true

      - name: Generate test report
        if: always()
        working-directory: backend
        run: mvn surefire-report:report -B

      - name: Package application
        working-directory: backend
        run: mvn package -DskipTests -B

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 5

      - name: Comment build status on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ SUCCESS' : '‚ùå FAILED';
            const comment = `
            ## Backend Build ${status}

            **Build Details:**
            - Java Version: 17
            - Maven Build: ${status}
            - Tests: ${{ steps.test.outcome || 'N/A' }}

            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.head_ref }}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  frontend-build:
    name: Frontend Build & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run linter
        working-directory: frontend
        run: npm run lint --if-present || echo "No lint script found"
        continue-on-error: true

      - name: Run tests
        working-directory: frontend
        run: npm test --if-present || echo "No test script found"
        continue-on-error: true

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 5

      - name: Comment build status on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ SUCCESS' : '‚ùå FAILED';
            const comment = `
            ## Frontend Build ${status}

            **Build Details:**
            - Node Version: 18
            - Build: ${status}
            - Linting: ${{ steps.lint.outcome || 'N/A' }}

            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.head_ref }}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Run code quality checks
        run: |
          echo "Running code quality checks..."

          # Check for console.log in frontend
          if grep -r "console\.log" frontend/src --include="*.tsx" --include="*.ts" --include="*.jsx" --include="*.js" 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: console.log statements found in frontend code"
          fi

          # Check for TODO comments
          TODO_COUNT=$(grep -r "TODO" backend/src frontend/src 2>/dev/null | wc -l || echo "0")
          echo "üìù TODO comments found: $TODO_COUNT"

          # Check for hardcoded secrets (basic check)
          if grep -r -i "password\s*=\s*['\"]" backend/src 2>/dev/null | grep -v "application.yml"; then
            echo "‚ùå ERROR: Possible hardcoded password found!"
            exit 1
          fi

      - name: Check file sizes
        run: |
          echo "Checking for large files..."
          find . -type f -size +5M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./target/*" || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build, code-quality]
    if: always()

    steps:
      - name: Generate PR summary
        uses: actions/github-script@v7
        with:
          script: |
            const backendStatus = '${{ needs.backend-build.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const frontendStatus = '${{ needs.frontend-build.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const qualityStatus = '${{ needs.code-quality.result }}' === 'success' ? '‚úÖ' : '‚ùå';

            const allPassed = '${{ needs.backend-build.result }}' === 'success' &&
                             '${{ needs.frontend-build.result }}' === 'success' &&
                             '${{ needs.code-quality.result }}' === 'success';

            const summary = `
            ## üîç PR Build Summary

            | Check | Status |
            |-------|--------|
            | Backend Build & Tests | ${backendStatus} |
            | Frontend Build & Tests | ${frontendStatus} |
            | Code Quality | ${qualityStatus} |

            **Overall Status:** ${allPassed ? '‚úÖ All checks passed! Ready for review.' : '‚ùå Some checks failed. Please fix before merging.'}

            **PR Details:**
            - Author: @${{ github.actor }}
            - Branch: ${{ github.head_ref }} ‚Üí ${{ github.base_ref }}
            - Commit: ${{ github.sha }}

            ${allPassed ? '‚ú® This PR is ready to be reviewed and merged!' : '‚ö†Ô∏è  Please address the failing checks before requesting review.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Set PR check status
        run: |
          if [ "${{ needs.backend-build.result }}" != "success" ] ||
             [ "${{ needs.frontend-build.result }}" != "success" ] ||
             [ "${{ needs.code-quality.result }}" != "success" ]; then
            echo "‚ùå PR checks failed"
            exit 1
          fi
          echo "‚úÖ All PR checks passed"
